
services:
  vitals-db:
    image: timescale/timescaledb:latest-pg16
    container_name: timescaledb
    environment:
      - POSTGRES_USER=${POSTGRES_USER_VITALS}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD_VITALS}
      - POSTGRES_DB=${POSTGRES_DB_VITALS}
    expose:
      - "5432"
    volumes:
      - ./db/vitalsdb/data:/var/lib/postgresql/data
      - ./db/init/vitals:/docker-entrypoint-initdb.d/
    networks:
      - health-platform-network


  mqtt-broker:
    image: eclipse-mosquitto:2
    container_name: mosquitto
    expose:
      - "1883"
      - "9001"
    volumes:
      - ./mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf
    networks:
      - health-platform-network

  medicine-db:
    image: postgres:14-alpine
    container_name: medicine-db
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD_MEDICINE}
      - POSTGRES_USER=${POSTGRES_USER_MEDICINE}
      - POSTGRES_DB=${POSTGRES_DB_MEDICINE}
    expose:
      - "5432"
    volumes:
      - ./db/medicinedb/data:/var/lib/postgresql/data
      - ./db/init/medicine:/docker-entrypoint-initdb.d/
    networks:
      - health-platform-network


  keycloak-db:
    image: postgres:16
    container_name: keycloak-db
    environment:
      - POSTGRES_USER=${POSTGRES_USER_KEYCLOAK}
      - POSTGRES_PASSWORD=&{POSTGRES_PASSWORD_KEYCLOAK}
      - POSTGRES_DB=${POSTGRES_DB_KEYCLOAK}
    expose:
      - "5432"
    volumes:
      - /home/fofi/postgresql/keycloak/data:/var/lib/postgresql/data
    networks:
      - health-platform-network


  keycloak:
    image: quay.io/keycloak/keycloak:26.3.4
    command: start-dev 
    container_name: keycloak
    environment:
      - KC_PROXY_HEADERS=xforwarded
      - KC_HOSTNAME=${KC_HOSTNAME}
      - KC_HTTP_RELATIVE_PATH=${KC_HTTP_RELATIVE_PATH}
      - KC_DB_URL=${KC_DB_URL}
      - KC_DB=${KC_DB}
      - KC_DB_PASSWORD=${KC_DB_PASSWORD}
      - KC_BOOTSTRAP_ADMIN_USERNAME=${KC_BOOTSTRAP_ADMIN_USERNAME}
      - KC_BOOTSTRAP_ADMIN_PASSWORD=${KC_BOOTSTRAP_ADMIN_PASSWORD}
    expose:
      - "8080"
    #network_mode: host
    depends_on:
      - keycloak-db
    networks:
      - health-platform-network

  gateway:
    image: nginx:alpine
    container_name: gateway
    ports:
      - "80:80"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/index.html:/etc/nginx/html/index.html
      - ./nginx/sea-edge-79ab30e2.png:/etc/nginx/html/sea-edge-79ab30e2.png
    depends_on:
      - vitals-subscriber
      - medicine-calendar
      - keycloak
    networks:
      - health-platform-network

  vitals-publisher:
    image: pokerface03/healthplatform:vitals-publisher_1.1
    container_name: vitals-publisher
    expose:
      - "8081"
    environment:
      - MQTT_AUTOMATIC_RECONNECT=true
      - MQTT_CLEAN_SESSION=true
      - MQTT_CONNECTION_TIMEOUT=10
      - MQTT_CLIENT_ID=${MQTT_CLIENT_ID_PUB}
      - MQTT_HOSTNAME=${MQTT_HOSTNAME}
      - MQTT_PORT=${MQTT_PORT}
    depends_on:
      - mqtt-broker
    networks:
      - health-platform-network
    restart: unless-stopped

  vitals-subscriber:
    image: pokerface03/healthplatform:vitals-subscriber_1.1
    container_name: vitals-subscriber
    expose:
      - "8082"
    environment:
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL_VITALS}
      - SPRING_DATASOURCE_USERNAME=${POSTGRES_USER_VITALS}
      - SPRING_DATASOURCE_PASSWORD=${POSTGRES_PASSWORD_VITALS}
      - JWT_SET_URI=${JWT_SET_URI}
      - JWT_ISSUER_URI=${JWT_ISSUER_URI}
      - MQTT_CLIENT_ID=${MQTT_CLIENT_ID_SUB}
      - MQTT_HOSTNAME=${MQTT_HOSTNAME}
      - MQTT_PORT=${MQTT_PORT}
    depends_on:
      - vitals-db
      - keycloak
      - mqtt-broker
    networks:
      - health-platform-network
    restart: unless-stopped

  medicine-calendar:
    image: pokerface03/healthplatform:medicine-calendar_1.1
    container_name: medicine-calendar
    expose:
      - "8083"
    environment:
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL_MEDICINE}
      - SPRING_DATASOURCE_USERNAME=${POSTGRES_USER_MEDICINE}
      - SPRING_DATASOURCE_PASSWORD=${POSTGRES_PASSWORD_MEDICINE}
      - JWT_SET_URI=${JWT_SET_URI}
      - JWT_ISSUER_URI=${JWT_ISSUER_URI}
    depends_on:
      - medicine-db
      - keycloak
    networks:
      - health-platform-network
    restart: unless-stopped



networks:
  health-platform-network:
    driver: bridge
    internal: false